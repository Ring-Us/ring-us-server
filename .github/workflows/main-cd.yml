name: CI/CD Workflow for EC2 Deployment

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1.ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. EC2ë¡œ ì½”ë“œ ë³µì‚¬ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "[GitHub Actions] Starting deployment on EC2"

            # ë ˆí¬ì§€í† ë¦¬ í´ë¡  ë˜ëŠ” Pull
            if [ -d "/home/ubuntu/ring-us-server" ]; then
              echo "[GitHub Actions] Pulling latest code"
              cd /home/ubuntu/ring-us-server && git pull origin main
            else
              echo "[GitHub Actions] Cloning repository"
              git clone git@github.com:Ring-Us/ring-us-server.git /home/ubuntu/ring-us-server
              cd /home/ubuntu/ring-us-server
              
              echo "${{ secrets.ENV_FILE }}" > .env.dev
            fi
            

            # ğŸ›  Gradle ë¹Œë“œ ê¶Œí•œ ì„¤ì •
            echo "[GitHub Actions] ğŸ”§ Fixing Gradle permissions"
            sudo chown -R $USER:$USER ~/.gradle
            sudo chmod -R 777 ~/.gradle

            # ê¶Œí•œ ì„¤ì • (dev.sh ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡, ì¶”í›„ì— deploy.shì™€ ë¶„ë¦¬)
            sudo chmod +x dev.sh

            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ, ë¹Œë“œ, ë°°í¬ í¬í•¨)
            sudo ./dev.sh
